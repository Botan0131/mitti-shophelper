<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex,nofollow">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="format-detection" content="telephone=no">

  <link rel="icon" href="icons/icon-192.png">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <title>MITTI ShopHelper</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b1020">
  <link rel="stylesheet" href="style.css" />
</head>

<body data-mode="PRO">
  <div class="bg">
    <div class="bg-aurora"></div>
    <div class="bg-grid"></div>
    <div class="bg-stars"></div>
  </div>

  <header class="app-header">
    <div class="brand">
      <div class="brand-title">
        MITTI ShopHelper <span class="brand-badge">NEON</span>
      </div>
      <div class="brand-sub">みっちのための買い物計算アプリ</div>
    </div>

    <div class="hud" aria-label="設定">
      <button id="modeToggle" class="btn ghost small" type="button">モード：詳細</button>

      <button id="bgmToggle" class="btn ghost small" type="button">BGM：OFF</button>
      <button id="sfxToggle" class="btn ghost small" type="button">効果音：ON</button>
      <label class="hud-vol">
        <span>音量</span>
        <input id="bgmVolume" type="range" min="0" max="100" value="35" />
      </label>
    </div>

    <nav class="tabs" aria-label="画面切り替え">
      <button class="tab is-active" data-screen="calc" type="button">計算</button>
      <button class="tab" data-screen="shops" type="button">店</button>
      <button class="tab" data-screen="history" type="button">履歴</button>
      <button class="tab only-pro" data-screen="verify" type="button">検証</button>
      <button class="tab" data-screen="help" type="button">使い方</button>
      <div class="tab-underline" aria-hidden="true"></div>
    </nav>
  </header>

  <main class="container">
    <!-- 計算 -->
    <section id="screen-calc" class="screen is-active">
      <div class="card">
        <div class="row between">
          <h2>店選択</h2>
          <button id="goShops" class="btn ghost" type="button">店登録へ</button>
        </div>

        <div class="row wrap">
          <label class="field grow">
            <span>店</span>
            <select id="shopSelect"></select>
          </label>

          <div class="pill">
            <div class="pill-title">計算ルール</div>
            <div id="policySummary" class="pill-body"></div>
          </div>
        </div>

        <p id="shopMemoView" class="muted"></p>
      </div>

      <div class="card">
        <div class="row between">
          <h2>商品入力</h2>
          <div class="row wrap">
            <button id="addItem" class="btn" type="button">商品追加</button>
            <button id="clearCart" class="btn ghost" type="button">入力クリア</button>
          </div>
        </div>

        <!-- 簡単モード：一括設定バー -->
         <div class="simplebar only-simple">
            <button id="simplePriceModeToggle" class="btn ghost" type="button">価格：税抜</button>
            <div class="simplebar-group">
                <span class="muted">追加する商品の税率：</span>
                <button id="simpleDefaultRate8" class="btn ghost small" type="button" aria-pressed="false">8%</button>
                <button id="simpleDefaultRate10" class="btn ghost small" type="button" aria-pressed="true">10%</button>
            </div>
            
            <div class="muted">※商品名・割引は非表示</div>
        </div>


        <div id="itemList" class="items"></div>
      </div>

      <!-- 詳細モードのみ表示 -->
      <div class="card only-pro">
        <div class="row between">
          <h2>割引・クーポン</h2>
          <div class="muted">行割引は商品カード内で設定できます。</div>
        </div>

        <div class="grid2">
          <label class="field">
            <span>合計割引の種類</span>
            <select id="totalDiscountType">
              <option value="NONE">なし</option>
              <option value="PERCENT">％引き</option>
              <option value="YEN">円引き</option>
            </select>
          </label>

          <label class="field">
            <span>合計割引の値</span>
            <input id="totalDiscountValue" inputmode="numeric" placeholder="例：5（％） または 100（円）" />
          </label>

          <label class="field">
            <span>合計割引の適用対象</span>
            <select id="totalDiscountTarget">
              <option value="BASE">税抜合計に適用</option>
              <option value="TOTAL">税込合計に適用</option>
            </select>
          </label>

          <div class="note">
            <div class="note-title">補足</div>
            <div class="note-body">
              複数税率の場合、税抜合計への円引きは、税抜金額の比率で自動配分します。
            </div>
          </div>
        </div>
      </div>

      <div class="card glow">
        <div class="row between">
          <h2>合計</h2>
          <button id="saveHistory" class="btn ghost" type="button">履歴保存</button>
        </div>

        <div class="result">
          <div class="result-line"><span>小計（税抜）</span><strong id="subtotal">0円</strong></div>
          <div class="result-line"><span>税額</span><strong id="tax">0円</strong></div>
          <div class="result-line"><span>税込合計（割引前）</span><strong id="totalBefore">0円</strong></div>
          <div class="result-line only-pro"><span>割引</span><strong id="discount">0円</strong></div>
          <div class="result-line total"><span>支払合計</span><strong id="payTotal">0円</strong></div>
        </div>

        <p id="calcNote" class="muted"></p>
        <p class="muted only-simple" style="margin-top:8px;">
          簡単モードでは、割引・検証・高度な丸め設定を非表示にしています。必要な場合は「モード：詳細」に切り替えてください。
        </p>
      </div>
    </section>

    <!-- 店 -->
    <section id="screen-shops" class="screen">
      <div class="card">
        <div class="row between">
          <h2>店登録</h2>
          <div class="row wrap only-pro">
            <button id="exportAll" class="btn ghost" type="button">全店エクスポート</button>
            <label class="filebtn btn ghost">
              インポート
              <input id="importFile" type="file" accept="application/json" />
            </label>
          </div>
        </div>

        <div class="grid2">
          <label class="field">
            <span>店名</span>
            <input id="shopName" placeholder="例：〇〇スーパー" />
          </label>

          <label class="field">
            <span>税率（固定）</span>
            <div class="chips">
              <label class="chip"><input id="rate8" type="checkbox" checked>8%</label>
              <label class="chip"><input id="rate10" type="checkbox" checked>10%</label>
            </div>
          </label>

          <label class="field">
            <span>プリセット</span>
            <select id="preset">
              <option value="PRESET_ITEM_ROUND">商品ごとに税計算（レジ方式）</option>
              <option value="PRESET_RATE_GROUP">税率ごとに合計して税計算（まとめ方式）</option>
              <option value="CUSTOM">カスタム</option>
            </select>
          </label>

          <!-- 詳細設定は詳細モードだけ -->
          <div class="only-pro">
            <label class="field">
              <span>計算方式（aggregation）</span>
              <select id="aggregation">
                <option value="ITEM_ROUND">商品ごとに丸め</option>
                <option value="RATE_GROUP_ROUND">税率ごとにまとめて丸め</option>
              </select>
            </label>
          </div>

          <div class="only-pro">
            <label class="field">
              <span>端数処理（丸め方法）</span>
              <select id="roundingMethod">
                <option value="ROUND">四捨五入</option>
                <option value="FLOOR">切り捨て</option>
                <option value="CEIL">切り上げ</option>
              </select>
            </label>
          </div>

          <div class="only-pro">
            <label class="field">
              <span>丸め単位</span>
              <select id="roundingUnit">
                <option value="1">1円</option>
                <option value="10">10円</option>
                <option value="100">100円</option>
              </select>
            </label>
          </div>

          <div class="only-pro">
            <label class="field">
              <span>税込→税抜の丸め（入力が税込のとき）</span>
              <select id="inclToBaseRounding">
                <option value="NONE">なし</option>
                <option value="ROUND">四捨五入</option>
                <option value="FLOOR">切り捨て</option>
                <option value="CEIL">切り上げ</option>
              </select>
            </label>
          </div>

          <label class="field">
            <span>メモ</span>
            <input id="shopMemo" placeholder="例：この店は商品ごとに端数処理があります。" />
          </label>
        </div>

        <div class="row wrap">
          <button id="saveShop" class="btn" type="button">登録</button>
          <button id="resetShop" class="btn ghost" type="button">リセット</button>
          <button id="cancelEdit" class="btn ghost is-hidden" type="button">編集キャンセル</button>
        </div>

        <p class="muted only-pro">
          店の計算ルールは、履歴に保存するときに一緒に記録します。後から店設定を変更しても、履歴の合計は崩れません。
        </p>
        <p class="muted only-simple">
          簡単モードでは、店設定は「プリセット」を中心に使います。細かい丸めを調整したい場合は、詳細モードに切り替えてください。
        </p>
      </div>

      <div class="card">
        <div class="row between">
          <h2>登録済みの店</h2>
          <button id="seedDemo" class="btn ghost" type="button">例の店を追加</button>
        </div>
        <div id="shopList" class="list"></div>
        <div class="row">
          <button id="deleteAllShops" class="btn danger" type="button">店を全削除</button>
        </div>
      </div>
    </section>

    <!-- 履歴 -->
    <section id="screen-history" class="screen">
      <div class="card">
        <div class="row between">
          <h2>履歴</h2>
          <button id="deleteAllHistory" class="btn danger" type="button">履歴を全削除</button>
        </div>
        <div id="historyList" class="list"></div>
      </div>
    </section>

    <!-- 検証（詳細モードのみ） -->
    <section id="screen-verify" class="screen only-pro">
      <div class="card">
        <h2>レシート検証</h2>
        <p class="muted">
          現在の入力内容から合計を計算し、レシート合計と一致するか確認します。差分がある場合は、合いそうな丸め設定候補を提示します。
        </p>

        <div class="grid2">
          <label class="field">
            <span>レシートの支払合計（円）</span>
            <input id="receiptTotal" inputmode="numeric" placeholder="例：1234" />
          </label>

          <div class="note">
            <div class="note-title">確認事項</div>
            <div class="note-body">
              行割引・合計割引も含めて、今の入力どおりに検証します。レシートの割引条件が異なる場合は、入力内容を合わせてください。
            </div>
          </div>
        </div>

        <div class="row wrap">
          <button id="runVerify" class="btn" type="button">検証開始</button>
          <button id="applySuggested" class="btn ghost" type="button" disabled>候補を店に適用</button>
        </div>

        <div id="verifyResult" class="verify"></div>
      </div>
    </section>

    <!-- 使い方 -->
<section id="screen-help" class="screen">
  <div class="card">
    <h2>使い方</h2>

    <div class="note">
      <div class="note-title">まず最初にすること（1分）</div>
      <div class="note-body">
        1. 「店」タブで、よく行くお店を1つ登録します。<br>
        2. 「計算」タブで、その店を選びます。<br>
        3. 「商品追加」を押して、価格・数量・税率（8% / 10%）を入れます。<br>
        4. 右下の「支払合計」を見ればOKです。必要なら「履歴保存」も押せます。
      </div>
    </div>

    <details class="note" style="margin-top:12px;" open>
      <summary class="note-title">画面の説明（ボタンの意味）</summary>
      <div class="note-body">
        <strong>① 計算</strong><br>
        <ul class="help">
          <li><strong>店</strong>：いま計算したいお店を選びます。</li>
          <li><strong>店登録へ</strong>：お店の登録画面へ移動します。</li>
          <li><strong>商品追加</strong>：入力行（カード）を1つ増やします。</li>
          <li><strong>入力クリア</strong>：今の買い物の入力を全部消します（店プロフィールは消えません）。</li>
          <li><strong>履歴保存</strong>：今の計算結果を「履歴」に残します（あとで見返せます）。</li>
        </ul>

        <strong>② 店</strong><br>
        <ul class="help">
          <li><strong>登録</strong>：入力中の店プロフィールを保存します。</li>
          <li><strong>リセット</strong>：入力フォームを空に戻します（保存済みの店は消えません）。</li>
          <li><strong>各店の「編集」</strong>：その店の設定をフォームに読み込んで直せます。</li>
          <li><strong>各店の「削除」</strong>：その店プロフィールを消します。</li>
          <li><strong>全店エクスポート / インポート</strong>：端末移行用です（詳細モードで表示）。</li>
        </ul>

        <strong>③ 履歴</strong><br>
        <ul class="help">
          <li><strong>履歴削除</strong>：履歴を消します。店プロフィールは残ります。</li>
          <li>履歴には「その時の店の計算ルール」も一緒に保存されるので、後から店設定を変えても履歴が崩れません。</li>
        </ul>

        <strong>④ 検証（詳細モード）</strong><br>
        <ul class="help">
          <li><strong>レシート合計</strong>：実際のレシートの合計金額（支払額）を入れます。</li>
          <li><strong>検証開始</strong>：アプリの計算とレシート合計の差を出し、合いそうな丸め設定候補を探します。</li>
          <li><strong>候補を店に適用</strong>：見つかった候補を、その店プロフィールに反映します。</li>
        </ul>

        <strong>⑤ 右上のボタン</strong><br>
        <ul class="help">
          <li><strong>モード：簡単 / 詳細</strong>：迷いにくさ優先なら簡単、再現性・機能優先なら詳細です。</li>
          <li><strong>BGM / 効果音 / 音量</strong>：音を切りたい時はOFFにできます。BGMは最初にボタンを押す必要がある場合があります。</li>
        </ul>
      </div>
    </details>

    <details class="note" style="margin-top:12px;">
      <summary class="note-title">計算ルール（店によって違うところ）</summary>
      <div class="note-body">
        店によって「税の計算」と「端数処理（1円未満の扱い）」が違います。ここが、みっちが困っていた部分です。<br><br>
        <ul class="help">
          <li><strong>商品ごとに税計算（レジ方式）</strong>：商品1つずつに税をかけて、端数処理も商品ごとに入るイメージです。</li>
          <li><strong>税率ごとに合計して税計算（まとめ方式）</strong>：8%のものを全部足す → 税、10%も同様、というイメージです。</li>
        </ul>
        さらに詳細モードでは、<strong>切り捨て / 四捨五入 / 切り上げ</strong> や <strong>10円単位で丸め</strong> なども選べます。
      </div>
    </details>

    <details class="note" style="margin-top:12px;">
      <summary class="note-title">入力のコツ（間違えにくくする）</summary>
      <div class="note-body">
        <ul class="help">
          <li><strong>税抜 / 税込</strong>：商品カードの「価格の種類」で切り替えできます（簡単モードは上のバーで一括切替）。</li>
          <li><strong>数量</strong>：同じ商品を2個買ったら「2」です。</li>
          <li><strong>税率</strong>：8%（食品など）/ 10%（それ以外）。店プロフィールで、使う税率を固定できます。</li>
          <li><strong>割引</strong>：行（商品）にも、合計にも、％引き / 円引きを設定できます（詳細モード）。</li>
        </ul>
      </div>
    </details>

    <details class="note" style="margin-top:12px;">
      <summary class="note-title">オフライン利用（スマホで使う）</summary>
      <div class="note-body">
        このアプリはデータを端末内（localStorage）に保存します。基本的に通信は不要です。<br>
        <strong>最初の1回だけ</strong>、ネットにつながる状態で開いてください（必要なファイルを保存します）。<br><br>
        スマホでは「ホーム画面に追加」すると、アプリのように使えます。
      </div>
    </details>

    <details class="note" style="margin-top:12px;">
      <summary class="note-title">よくある困りごと</summary>
      <div class="note-body">
        <ul class="help">
          <li><strong>入力が反応しない / 古い画面のまま</strong>：オフライン保存の影響で、更新が反映されにくい時があります。右下に「更新があります」が出たら再読み込みしてください。</li>
          <li><strong>それでも直らない</strong>：ブラウザの「サイトデータを削除（キャッシュ削除）」をすると直ることがあります。</li>
        </ul>
      </div>
    </details>
  </div>
</section>

</main>


<div id="updateToast" class="toast is-hidden" role="status" aria-live="polite">
  <div class="toast-text">更新があります。反映するには再読み込みしてください。</div>
  <button id="reloadBtn" class="btn small" type="button">再読み込み</button>
</div>

  <footer class="footer">
    <div class="muted">MITTI ShopHelper / 保存先：端末内（localStorage）</div>
  </footer>
  <script src="app.js"></script>
  <script>
    // Service Worker（オフライン対応 + 更新反映）
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./sw.js").then((reg) => {
        const toast = document.getElementById("updateToast");
        const reloadBtn = document.getElementById("reloadBtn");

        const showToast = () => {
          if (!toast) return;
          toast.classList.remove("is-hidden");
          if (reloadBtn && reg.waiting) {
            reloadBtn.onclick = () => {
              // 新しいSWを即時有効化 → controllerchange でリロード
              reg.waiting.postMessage({ type: "SKIP_WAITING" });
            };
          }
        };

        // すでに待機中の更新がある場合
        if (reg.waiting) showToast();

        // 更新検知
        reg.addEventListener("updatefound", () => {
          const nw = reg.installing;
          if (!nw) return;
          nw.addEventListener("statechange", () => {
            // 既にページを開いている状態で新SWが入ったら、トースト表示
            if (nw.state === "installed" && navigator.serviceWorker.controller) {
              showToast();
            }
          });
        });
      }).catch(() => {});

      // 新SWが有効になったら1回だけリロード
      let reloading = false;
      navigator.serviceWorker.addEventListener("controllerchange", () => {
        if (reloading) return;
        reloading = true;
        window.location.reload();
      });
    }
  </script>
</body>
</html>
