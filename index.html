<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <meta name="theme-color" content="#0b1020">
  <meta name="robots" content="noindex,nofollow">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link rel="manifest" href="./manifest.json">
  <link rel="icon" href="./icons/icon-192.png">
  <link rel="apple-touch-icon" href="./icons/icon-192.png">

  <title>MITTI ShopHelper</title>
  <link rel="stylesheet" href="./style.css">
</head>

<body>
  <header class="app-header">
    <div class="brand">
      <div class="logo">M</div>
      <div class="brand-text">
        <div class="brand-title">MITTI ShopHelper</div>
        <div class="brand-sub">みっちのための買い物計算アプリ</div>
      </div>
    </div>

    <nav class="tabs" aria-label="ナビゲーション">
      <button class="tab is-active" data-screen="screen-calc" aria-current="page">計算</button>
      <button class="tab" data-screen="screen-shops">店</button>
      <button class="tab" data-screen="screen-history">履歴</button>
      <button class="tab" data-screen="screen-help">使い方</button>
      <div class="tab-underline" aria-hidden="true"></div>
    </nav>
  </header>

  <div id="updateToast" class="toast is-hidden" role="status" aria-live="polite">
    <div class="toast-text">新しいバージョンがあります。更新すると最新の修正が反映されます。</div>
    <div class="toast-actions">
      <button id="reloadBtn" class="btn btn-primary">更新</button>
      <button id="dismissBtn" class="btn btn-ghost">あとで</button>
    </div>
  </div>

  <main class="app-main">
    <!-- CALC -->
    <section id="screen-calc" class="screen is-active" aria-label="計算画面">
      <div class="grid">
        <div class="card">
          <div class="card-title-row">
            <h2>店を選択</h2>
            <div class="row">
              <span class="pill" id="modePill">モード：簡単</span>
              <button id="toggleModeBtn" class="btn btn-ghost" type="button">モード切替</button>
            </div>
          </div>

          <div class="row wrap">
            <select id="shopSelect" class="input" aria-label="店の選択"></select>
            <button id="openShopBtn" class="btn btn-secondary" type="button">店設定</button>
          </div>

          <div class="divider"></div>

          <div id="simpleBar" class="simple-bar">
            <div class="row wrap">
              <button class="seg is-on" data-simple-tax="10" type="button">10%</button>
              <button class="seg" data-simple-tax="8" type="button">8%</button>
              <span class="muted">追加は「商品を追加」→金額入力でOK。</span>
            </div>
          </div>

          <div id="cartArea"></div>

          <div class="row wrap gap">
            <button id="addItemBtn" class="btn btn-primary" type="button">商品を追加</button>
            <button id="clearCartBtn" class="btn btn-ghost" type="button">入力をクリア</button>
            <button id="saveHistoryBtn" class="btn btn-secondary" type="button">履歴に保存</button>
          </div>
        </div>

        <div class="card totals">
          <h2>合計</h2>
          <div class="totals-grid">
            <div class="totals-row">
              <div class="label">税抜合計</div>
              <div class="value" id="sumBase">0</div>
            </div>
            <div class="totals-row">
              <div class="label">消費税</div>
              <div class="value" id="sumTax">0</div>
            </div>
            <div class="totals-row big">
              <div class="label">支払合計（税込）</div>
              <div class="value" id="sumIncl">0</div>
            </div>
          </div>

          <div id="discountPanel" class="discount-panel"></div>

          <div id="verifyPanel" class="verify-panel"></div>
        </div>
      </div>
    </section>

    <!-- SHOPS -->
    <section id="screen-shops" class="screen" aria-label="店画面">
      <div class="grid">
        <div class="card">
          <div class="card-title-row">
            <h2>店プロフィール</h2>
            <div class="row">
              <button id="newShopBtn" class="btn btn-primary" type="button">新規</button>
              <button id="exportShopsBtn" class="btn btn-ghost" type="button">エクスポート</button>
              <label class="btn btn-ghost file-btn">
                インポート
                <input id="importShopsInput" type="file" accept="application/json" hidden>
              </label>
            </div>
          </div>

          <div class="row wrap">
            <select id="shopsList" class="input" aria-label="店一覧"></select>
            <button id="deleteShopBtn" class="btn btn-danger" type="button">削除</button>
          </div>

          <div class="divider"></div>

          <form id="shopForm" class="form">
            <label class="field">
              <span>店名</span>
              <input id="shopName" class="input" type="text" placeholder="例：スーパーA">
            </label>

            <label class="field">
              <span>プリセット（計算ルール）</span>
              <select id="shopPreset" class="input">
                <option value="item_tax_each">商品ごとに税計算→合計（一般的）</option>
                <option value="sum_then_tax">税抜合計→税計算（まとめて課税）</option>
                <option value="already_inclusive">入力は税込価格（内税）</option>
              </select>
            </label>

            <div class="note">
              <div class="note-title">詳細設定（詳細モード向け）</div>
              <div class="note-body">
                丸めや税抜⇄税込のルールは、お店によって違うことがあります。困ったときは「検証」タブでレシート合計と照合して調整できます。
              </div>
            </div>

            <div class="two-col">
              <label class="field">
                <span>丸め方法</span>
                <select id="shopRounding" class="input">
                  <option value="round">四捨五入</option>
                  <option value="floor">切り捨て</option>
                  <option value="ceil">切り上げ</option>
                </select>
              </label>

              <label class="field">
                <span>丸め単位（roundTo）</span>
                <select id="shopRoundTo" class="input">
                  <option value="1">1円</option>
                  <option value="10">10円</option>
                  <option value="100">100円</option>
                </select>
              </label>
            </div>

            <div class="two-col">
              <label class="field">
                <span>税の丸め（税額）</span>
                <select id="shopTaxRounding" class="input">
                  <option value="round">四捨五入</option>
                  <option value="floor">切り捨て</option>
                  <option value="ceil">切り上げ</option>
                </select>
              </label>

              <label class="field">
                <span>税込→税抜の丸め（inclToBaseRounding）</span>
                <select id="shopInclToBase" class="input">
                  <option value="round">四捨五入</option>
                  <option value="floor">切り捨て</option>
                  <option value="ceil">切り上げ</option>
                </select>
              </label>
            </div>

            <div class="row wrap gap">
              <button id="saveShopBtn" class="btn btn-secondary" type="button">保存</button>
              <button id="setAsCurrentBtn" class="btn btn-ghost" type="button">この店を計算に適用</button>
            </div>
          </form>
        </div>

        <div class="card">
          <h2>メモ</h2>
          <ul class="bullets">
            <li>履歴には「その時点の店ルール」も一緒に保存されます。</li>
            <li>後から店設定を変えても、過去の履歴が崩れにくい構造です。</li>
            <li>端末移行は「エクスポート/インポート」が便利です。</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- HISTORY -->
    <section id="screen-history" class="screen" aria-label="履歴画面">
      <div class="card">
        <div class="card-title-row">
          <h2>履歴</h2>
          <div class="row">
            <button id="clearHistoryBtn" class="btn btn-danger" type="button">履歴を全削除</button>
          </div>
        </div>

        <div id="historyList" class="history-list"></div>
      </div>
    </section>

    <!-- HELP -->
    <section id="screen-help" class="screen">
      <div class="card help">
        <h2>使い方</h2>

        <p class="muted">
          MITTI ShopHelper は、店によって違う「税の計算のしかた」や「端数処理」を再現して、支払合計を出すためのツールです。
          データは端末内に保存されます（サーバーに送信しません）。
        </p>

        <div class="note" style="margin-top:12px;">
          <div class="note-title">最短手順（まずはここだけ）</div>
          <div class="note-body">
            1. 「店」タブで、よく行くお店を登録します。<br>
            2. 「計算」タブで店を選び、商品を追加して金額を入力します。<br>
            3. 合計を見て、必要なら「履歴に保存」を押します。<br>
            4. 割引やレシート検証を使うときは「モード：詳細」に切り替えます。
          </div>
        </div>

        <div class="help-grid">
          <div class="help-block">
            <h3>画面（タブ）の説明</h3>
            <ul>
              <li><b>計算</b>：商品を入力して合計を出します。</li>
              <li><b>店</b>：店プロフィール（計算ルール）を登録・編集します。</li>
              <li><b>履歴</b>：保存した計算結果を見返したり削除したりできます。</li>
              <li><b>検証</b>（詳細モードのみ）：レシート合計と一致するか確認し、丸め設定の候補を出します。</li>
            </ul>
          </div>

          <div class="help-block">
            <h3>モードの違い</h3>
            <ul>
              <li><b>簡単</b>：最小限の入力（とにかく早く合計）。</li>
              <li><b>詳細</b>：端数処理／税込→税抜丸め／割引／検証などを使えます。</li>
            </ul>
            <p class="muted">迷ったら「簡単」でOK。合わないときだけ「詳細」に切り替えるのがおすすめです。</p>
          </div>

          <div class="help-block">
            <h3>店プロフィール（店タブ）</h3>
            <ul>
              <li><b>店名</b>：表示用の名前です。</li>
              <li><b>プリセット</b>：よくある計算ルールを一発で設定します。</li>
              <li><b>詳細設定</b>（詳細モード）：丸め方法・丸め単位・税込→税抜の丸めなどを細かく調整できます。</li>
              <li><b>全店エクスポート/インポート</b>：端末移行やバックアップに使えます（.json）。</li>
            </ul>
            <p class="muted">※履歴には「その時点の店ルール」も一緒に保存されるため、後から店設定を変えても履歴は崩れません。</p>
          </div>

          <div class="help-block">
            <h3>商品入力（計算タブ）</h3>
            <ul>
              <li><b>簡単モード</b>：金額だけをテンポよく入力します。税率は上のボタンで切り替えられます。</li>
              <li><b>詳細モード</b>：商品ごとに税率・税込/税抜、行割引などを設定できます。</li>
            </ul>
            <div class="note" style="margin-top:10px;">
              <div class="note-title">よくあるつまずき</div>
              <div class="note-body">
                価格が「1文字ずつ」しか入らないときは、古い版が残っている可能性があります。<br>
                いったんページを閉じて開き直すか、画面下の「更新」通知が出ていたら押してください。
              </div>
            </div>
          </div>

          <div class="help-block">
            <h3>割引（詳細モード）</h3>
            <ul>
              <li><b>行割引</b>：商品カード内で設定します（％引き／円引き）。</li>
              <li><b>合計割引</b>：画面の「割引・クーポン」カードで設定します（税抜合計/税込合計のどちらに適用するかも選べます）。</li>
            </ul>
          </div>

          <div class="help-block">
            <h3>レシート検証（詳細モード）</h3>
            <ol>
              <li>レシートの「支払合計」を入力します。</li>
              <li>「検証開始」を押します。</li>
              <li>差分が出たら、候補として提示された丸め設定を確認します。</li>
              <li>合いそうなら「候補を店に適用」を押して、店プロフィールへ反映できます。</li>
            </ol>
          </div>

          <div class="help-block">
            <h3>アイコンが変わらない／消えたように見えるとき</h3>
            <ul>
              <li>ホーム画面に追加済みの場合：一度削除して、もう一度「ホーム画面に追加」をしてください。</li>
              <li>それでも変わらない場合：ブラウザの「サイトデータ削除」→再追加が確実です。</li>
            </ul>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="app-footer">
    <div class="muted">
      v1.0.3 / オフライン対応 / 税率 8%・10% / 端数・割引・履歴・店プロフィール対応
    </div>
  </footer>

  <script src="./app.js"></script>
  <script>
    // Service Worker
    (async () => {
      if (!("serviceWorker" in navigator)) return;
      try {
        const reg = await navigator.serviceWorker.register("./sw.js");

        // 更新が来たらトースト表示
        function showUpdateToast(worker){
          const toast = document.getElementById("updateToast");
          const reloadBtn = document.getElementById("reloadBtn");
          const dismissBtn = document.getElementById("dismissBtn");
          toast.classList.remove("is-hidden");

          const onReload = () => {
            if (worker) worker.postMessage("SKIP_WAITING");
            toast.classList.add("is-hidden");
          };
          const onDismiss = () => {
            toast.classList.add("is-hidden");
          };
          reloadBtn.onclick = onReload;
          dismissBtn.onclick = onDismiss;
        }

        if (reg.waiting) showUpdateToast(reg.waiting);

        reg.addEventListener("updatefound", () => {
          const newWorker = reg.installing;
          if (!newWorker) return;
          newWorker.addEventListener("statechange", () => {
            if (newWorker.state === "installed" && navigator.serviceWorker.controller) {
              showUpdateToast(newWorker);
            }
          });
        });

        // skipWaiting後に自動リロード
        let refreshing = false;
        navigator.serviceWorker.addEventListener("controllerchange", () => {
          if (refreshing) return;
          refreshing = true;
          window.location.reload();
        });
      } catch (e) {
        // SW失敗でもアプリ自体は動く
      }
    })();
  </script>
</body>
</html>