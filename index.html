<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MITTI ShopHelper</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b1020">
  <link rel="stylesheet" href="style.css" />
</head>

<body data-mode="SIMPLE">
  <div class="bg">
    <div class="bg-aurora"></div>
    <div class="bg-grid"></div>
    <div class="bg-stars"></div>
  </div>

  <header class="app-header">
    <div class="brand">
      <div class="brand-title">
        MITTI ShopHelper <span class="brand-badge">NEON</span>
      </div>
      <div class="brand-sub">みっちのための買い物計算アプリ</div>
    </div>

    <div class="hud" aria-label="設定">
      <button id="modeToggle" class="btn ghost small" type="button">モード：詳細</button>

      <button id="bgmToggle" class="btn ghost small" type="button">BGM：OFF</button>
      <button id="sfxToggle" class="btn ghost small" type="button">効果音：ON</button>
      <label class="hud-vol">
        <span>音量</span>
        <input id="bgmVolume" type="range" min="0" max="100" value="35" />
      </label>
    </div>

    <nav class="tabs" aria-label="画面切り替え">
      <button class="tab is-active" data-screen="calc" type="button">計算</button>
      <button class="tab" data-screen="shops" type="button">店</button>
      <button class="tab" data-screen="history" type="button">履歴</button>
      <button class="tab only-pro" data-screen="verify" type="button">検証</button>
      <button class="tab" data-screen="help" type="button">使い方</button>
      <div class="tab-underline" aria-hidden="true"></div>
    </nav>
  </header>

  <div id="updateToast" class="toast is-hidden" role="status" aria-live="polite">
    <div class="toast-text">新しいバージョンがあります。更新すると最新の修正が反映されます。</div>
    <div class="toast-actions">
      <button id="reloadBtn" class="btn" type="button">更新</button>
      <button id="dismissUpdate" class="btn ghost" type="button">後で</button>
    </div>
  </div>

  <main class="container">
    <!-- 計算 -->
    <section id="screen-calc" class="screen is-active">
      <div class="card">
        <div class="row between">
          <h2>店選択</h2>
          <button id="goShops" class="btn ghost" type="button">店登録へ</button>
        </div>

        <div class="row wrap">
          <label class="field grow">
            <span>店</span>
            <select id="shopSelect"></select>
          </label>

          <div class="pill">
            <div class="pill-title">計算ルール</div>
            <div id="policySummary" class="pill-body"></div>
          </div>
        </div>

        <p id="shopMemoView" class="muted"></p>
      </div>

      <div class="card">
        <div class="row between">
          <h2>商品入力</h2>
          <div class="row wrap">
            <button id="addItem" class="btn" type="button">商品追加</button>
            <button id="clearCart" class="btn ghost" type="button">入力クリア</button>
          </div>
        </div>

        <!-- 簡単モード：一括設定バー -->
         <div class="simplebar only-simple">
            <button id="simplePriceModeToggle" class="btn ghost" type="button">価格：税抜</button>
            <div class="simplebar-group">
                <span class="muted">追加は</span>
                <button id="simpleDefaultRate8" class="btn ghost small" type="button" aria-pressed="false">8%</button>
                <button id="simpleDefaultRate10" class="btn ghost small" type="button" aria-pressed="true">10%</button>
            </div>
            
            <div class="muted">※商品名・割引は非表示</div>
        </div>


        <div id="itemList" class="items"></div>
      </div>

      <!-- 詳細モードのみ表示 -->
      <div class="card only-pro">
        <div class="row between">
          <h2>割引・クーポン</h2>
          <div class="muted">行割引は商品カード内で設定できます。</div>
        </div>

        <div class="grid2">
          <label class="field">
            <span>合計割引の種類</span>
            <select id="totalDiscountType">
              <option value="NONE">なし</option>
              <option value="PERCENT">％引き</option>
              <option value="YEN">円引き</option>
            </select>
          </label>

          <label class="field">
            <span>合計割引の値</span>
            <input id="totalDiscountValue" inputmode="numeric" placeholder="例：5（％） または 100（円）" />
          </label>

          <label class="field">
            <span>合計割引の適用対象</span>
            <select id="totalDiscountTarget">
              <option value="BASE">税抜合計に適用</option>
              <option value="TOTAL">税込合計に適用</option>
            </select>
          </label>

          <div class="note">
            <div class="note-title">補足</div>
            <div class="note-body">
              複数税率の場合、税抜合計への円引きは、税抜金額の比率で自動配分します。
            </div>
          </div>
        </div>
      </div>

      <div class="card glow">
        <div class="row between">
          <h2>合計</h2>
          <button id="saveHistory" class="btn ghost" type="button">履歴保存</button>
        </div>

        <div class="result">
          <div class="result-line"><span>小計（税抜）</span><strong id="subtotal">0円</strong></div>
          <div class="result-line"><span>税額</span><strong id="tax">0円</strong></div>
          <div class="result-line"><span>税込合計（割引前）</span><strong id="totalBefore">0円</strong></div>
          <div class="result-line only-pro"><span>割引</span><strong id="discount">0円</strong></div>
          <div class="result-line total"><span>支払合計</span><strong id="payTotal">0円</strong></div>
        </div>

        <p id="calcNote" class="muted"></p>
        <p class="muted only-simple" style="margin-top:8px;">
          簡単モードでは、割引・検証・高度な丸め設定を非表示にしています。必要な場合は「モード：詳細」に切り替えてください。
        </p>
      </div>
    </section>

    <!-- 店 -->
    <section id="screen-shops" class="screen">
      <div class="card">
        <div class="row between">
          <h2>店登録</h2>
          <div class="row wrap only-pro">
            <button id="exportAll" class="btn ghost" type="button">全店エクスポート</button>
            <label class="filebtn btn ghost">
              インポート
              <input id="importFile" type="file" accept="application/json" />
            </label>
          </div>
        </div>

        <div class="grid2">
          <label class="field">
            <span>店名</span>
            <input id="shopName" placeholder="例：〇〇スーパー" />
          </label>

          <label class="field">
            <span>税率（固定）</span>
            <div class="chips">
              <label class="chip"><input id="rate8" type="checkbox" checked>8%</label>
              <label class="chip"><input id="rate10" type="checkbox" checked>10%</label>
            </div>
          </label>

          <label class="field">
            <span>プリセット</span>
            <select id="preset">
              <option value="PRESET_ITEM_ROUND">商品ごとに税計算（レジ方式）</option>
              <option value="PRESET_RATE_GROUP">税率ごとに合計して税計算（まとめ方式）</option>
              <option value="CUSTOM">カスタム</option>
            </select>
          </label>

          <!-- 詳細設定は詳細モードだけ -->
          <div class="only-pro">
            <label class="field">
              <span>計算方式（aggregation）</span>
              <select id="aggregation">
                <option value="ITEM_ROUND">商品ごとに丸め</option>
                <option value="RATE_GROUP_ROUND">税率ごとにまとめて丸め</option>
              </select>
            </label>
          </div>

          <div class="only-pro">
            <label class="field">
              <span>端数処理（丸め方法）</span>
              <select id="roundingMethod">
                <option value="ROUND">四捨五入</option>
                <option value="FLOOR">切り捨て</option>
                <option value="CEIL">切り上げ</option>
              </select>
            </label>
          </div>

          <div class="only-pro">
            <label class="field">
              <span>丸め単位</span>
              <select id="roundingUnit">
                <option value="1">1円</option>
                <option value="10">10円</option>
                <option value="100">100円</option>
              </select>
            </label>
          </div>

          <div class="only-pro">
            <label class="field">
              <span>税込→税抜の丸め（入力が税込のとき）</span>
              <select id="inclToBaseRounding">
                <option value="NONE">なし</option>
                <option value="ROUND">四捨五入</option>
                <option value="FLOOR">切り捨て</option>
                <option value="CEIL">切り上げ</option>
              </select>
            </label>
          </div>

          <label class="field">
            <span>メモ</span>
            <input id="shopMemo" placeholder="例：この店は商品ごとに端数処理があります。" />
          </label>
        </div>

        <div class="row wrap">
          <button id="saveShop" class="btn" type="button">登録</button>
          <button id="resetShop" class="btn ghost" type="button">リセット</button>
          <button id="cancelEdit" class="btn ghost is-hidden" type="button">編集キャンセル</button>
        </div>

        <p class="muted only-pro">
          店の計算ルールは、履歴に保存するときに一緒に記録します。後から店設定を変更しても、履歴の合計は崩れません。
        </p>
        <p class="muted only-simple">
          簡単モードでは、店設定は「プリセット」を中心に使います。細かい丸めを調整したい場合は、詳細モードに切り替えてください。
        </p>
      </div>

      <div class="card">
        <div class="row between">
          <h2>登録済みの店</h2>
          <button id="seedDemo" class="btn ghost" type="button">例の店を追加</button>
        </div>
        <div id="shopList" class="list"></div>
        <div class="row">
          <button id="deleteAllShops" class="btn danger" type="button">店を全削除</button>
        </div>
      </div>
    </section>

    <!-- 履歴 -->
    <section id="screen-history" class="screen">
      <div class="card">
        <div class="row between">
          <h2>履歴</h2>
          <button id="deleteAllHistory" class="btn danger" type="button">履歴を全削除</button>
        </div>
        <div id="historyList" class="list"></div>
      </div>
    </section>

    <!-- 検証（詳細モードのみ） -->
    <section id="screen-verify" class="screen only-pro">
      <div class="card">
        <h2>レシート検証</h2>
        <p class="muted">
          現在の入力内容から合計を計算し、レシート合計と一致するか確認します。差分がある場合は、合いそうな丸め設定候補を提示します。
        </p>

        <div class="grid2">
          <label class="field">
            <span>レシートの支払合計（円）</span>
            <input id="receiptTotal" inputmode="numeric" placeholder="例：1234" />
          </label>

          <div class="note">
            <div class="note-title">確認事項</div>
            <div class="note-body">
              行割引・合計割引も含めて、今の入力どおりに検証します。レシートの割引条件が異なる場合は、入力内容を合わせてください。
            </div>
          </div>
        </div>

        <div class="row wrap">
          <button id="runVerify" class="btn" type="button">検証開始</button>
          <button id="applySuggested" class="btn ghost" type="button" disabled>候補を店に適用</button>
        </div>

        <div id="verifyResult" class="verify"></div>
      </div>
    </section>

    <!-- 使い方 -->
    <section id="screen-help" class="screen">
      <div class="card">
        <h2>使い方</h2>
        <p class="muted">
          このアプリは、店によって違う「税の計算のしかた」や「端数処理」を再現して、支払合計を出すためのツールです。
          上の「モード」ボタンで、簡単／詳細を切り替えられます。
        </p>

        <div class="note" style="margin-top:12px;">
          <div class="note-title">最短手順</div>
          <div class="note-body">
            1. 「店」タブで店プロフィールを登録します。<br>
            2. 「計算」タブで店を選び、商品を入力します。<br>
            3. 支払合計を確認し、必要なら「履歴保存」を押します。<br>
            4. 割引や検証が必要な場合は「モード：詳細」に切り替えてください。
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="muted">MITTI ShopHelper / 保存先：端末内（localStorage）</div>
  </footer>

  <script src="app.js"></script>
  <script>
  // PWA（オフライン対応）
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js").then((reg) => {
      const toast = document.getElementById("updateToast");
      const reloadBtn = document.getElementById("reloadBtn");
      const dismissBtn = document.getElementById("dismissUpdate");

      const showToast = () => {
        if (!toast) return;
        toast.classList.remove("is-hidden");
      };

      const hideToast = () => {
        if (!toast) return;
        toast.classList.add("is-hidden");
      };

      // すでに待機中のSWがある場合
      if (reg.waiting && navigator.serviceWorker.controller) {
        showToast();
      }

      reg.addEventListener("updatefound", () => {
        const nw = reg.installing;
        if (!nw) return;
        nw.addEventListener("statechange", () => {
          if (nw.state === "installed" && navigator.serviceWorker.controller) {
            showToast();
          }
        });
      });

      reloadBtn?.addEventListener("click", () => {
        // 新しいSWを有効化 → リロード
        if (reg.waiting) reg.waiting.postMessage("SKIP_WAITING");
      });

      dismissBtn?.addEventListener("click", hideToast);
    });

    navigator.serviceWorker.addEventListener("controllerchange", () => {
      // 新しいSWに切り替わったら再読み込み
      location.reload();
    });
  }
</script>
</body>
</html>